var listOfSites = {
  "cities": [
    {
      "cname": "Allston",
      "lat": "42.3495",
      "lng": "-71.1298",
      "monday": "1",
      "tuesday": "0",
    },
    {
      "cname": "Arlington - Norman",
      "lat": "42.4180",
      "lng": "-71.1580",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Arlington",
      "lat": "42.4168",
      "lng": "-71.1542",
      "monday": "1",
      "tuesday": "1"
    },
    {
      "cname": "Beverly",
      "lat": "42.5588",
      "lng": "-70.8873",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Boston - TMC",
      "lat": "42.3497",
      "lng": "-71.0631",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Bourne",
      "lat": "41.7410",
      "lng": "-70.5980",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Braintree",
      "lat": "42.2070",
      "lng": "-71.0242",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Brighton",
      "lat": "42.3491",
      "lng": "-71.1426",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Brockton",
      "lat": "42.0580",
      "lng": "-71.0621",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Brookline",
      "lat": "42.3432",
      "lng": "-71.1166",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Burlington",
      "lat": "42.4847",
      "lng": "-71.2049",
      "monday": "2",
      "tuesday": "1"
    },
    {
      "cname": "Charlestwon",
      "lat": "42.3776",
      "lng": "-71.0569",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Charlton",
      "lat": "42.1452",
      "lng": "-71.9695",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Danvers",
      "lat": "42.5486",
      "lng": "-70.9327",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Dedham",
      "lat": "42.2267",
      "lng": "-71.1777",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Derry, NH",
      "lat": "42.8976",
      "lng": "-71.3241",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Framingham",
      "lat": "42.2878",
      "lng": "-71.4238",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Holbrook",
      "lat": "42.1585",
      "lng": "-71.0064",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Lakeville",
      "lat": "41.8463",
      "lng": "-70.9524",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Marblehead",
      "lat": "42.4663",
      "lng": "-70.9436",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Malden",
      "lat": "42.4296",
      "lng": "-71.0870",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Manchester",
      "lat": "42.5931",
      "lng": "-70.7637",
      "monday": "1",
      "tuesday": "0"
    },

    {
      "cname": "Medford",
      "lat": "42.4188",
      "lng": "-71.1128",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Middleton",
      "lat": "42.5841",
      "lng": "-71.0093",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Needham - London",
      "lat": "42.2773",
      "lng": "-71.2386",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Needham - Perez-Lirio",
      "lat": "42.2909",
      "lng": "-71.2373",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Needham - Frank",
      "lat": "42.2752",
      "lng": "-71.2374",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "North Falmouth",
      "lat": "41.6410",
      "lng": "-70.6124",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Pembroke",
      "lat": "42.1078",
      "lng": "-70.7631",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Randolph",
      "lat": "42.1928",
      "lng": "-71.0593",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Revere",
      "lat": "42.4185",
      "lng": "-70.9945",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Somerville",
      "lat": "42.3976",
      "lng": "-71.1236",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Sudbury",
      "lat": "42.3610",
      "lng": "-71.4288",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Swampscott",
      "lat": "42.4766",
      "lng": "-70.9126",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Tewksbury - Lewis",
      "lat": "42.6313",
      "lng": "-71.2702",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Tewksbury - Ragucci",
      "lat": "42.5982",
      "lng": "-71.2181",
      "monday": "0",
      "tuesday": "1"
    },
    {
      "cname": "Walpole",
      "lat": "42.1372",
      "lng": "-71.2656",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Wareham",
      "lat": "41.7625",
      "lng": "-70.7222",
      "monday": "1",
      "tuesday": "0"
    },
    {
      "cname": "Wellesley",
      "lat": "42.3168",
      "lng": "-71.2442",
      "monday": "0",
      "tuesday": "2"
    },
    {
      "cname": "Wellesley - Finn",
      "lat": "42.3249",
      "lng": "-71.2537",
      "monday": "0",
      "tuesday": "1"
    }
  ]
};
var cs_latlng = [];
var cs_latlng_1 = [];
var cs_latlng_2 = [];
var cs_marker = [];
var cs_contentString = [];
var cs_infowindow = [];
var map = null;
var mapOptions = null;
var dms = null;
var home_marker = null;

function qsort(a) {
    if (a.length == 0) return [];
 
    var left = [], right = [], pivot = a[0];
 
    for (var i = 1; i < a.length; i++) {
        a[i].duration < pivot.duration ? left.push(a[i]) : right.push(a[i]);
    }
    return qsort(left).concat(pivot, qsort(right));
}

function map_recenter(latlng,offsetx,offsety) {
    var point1 = map.getProjection().fromLatLngToPoint(
        (latlng instanceof google.maps.LatLng) ? latlng : map.getCenter()
    );
    var point2 = new google.maps.Point(
        ( (typeof(offsetx) == 'number' ? offsetx : 0) / Math.pow(2, map.getZoom()) ) || 0,
        ( (typeof(offsety) == 'number' ? offsety : 0) / Math.pow(2, map.getZoom()) ) || 0
    );  
    map.setCenter(map.getProjection().fromPointToLatLng(new google.maps.Point(
        point1.x - point2.x,
        point1.y + point2.y
    )));
}

function setEventListener(map, marker, infowindow){
    google.maps.event.addListener(marker, 'click', function() {
    map_recenter(marker.getPosition(),-200, 0);
    for (i = 0; i < cs_infowindow.length; i++){
      cs_infowindow[i].close();
    }
    infowindow.open(map,marker);
    });
}

function initialize() {
    mapOptions = {
      center: { lat: 42.304506, lng: -69.9500},
      zoom: 8
    };
    map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);
    dms = new google.maps.DistanceMatrixService();
    for (i = 0; i < listOfSites.cities.length; i++) { // Create LatLng object for each site
        cs_latlng.push(new google.maps.LatLng(listOfSites.cities[i].lat, 
            listOfSites.cities[i].lng));

        cs_contentString.push("<h3>" + listOfSites.cities[i].cname + "</h2>\n" + 
                              "<p> Monday slots: " + listOfSites.cities[i].monday + "<br />" +
                              "Tuesday slots: " + listOfSites.cities[i].tuesday + "</p>");
        cs_infowindow.push(new google.maps.InfoWindow({
            content: cs_contentString[i] }));
        cs_marker.push(new google.maps.Marker({
                        position: cs_latlng[i],
                        map: map,
                        title: listOfSites.cities[i].cname}));
        setEventListener(map, cs_marker[i], cs_infowindow[i]);
    }
    cs_latlng_1 = cs_latlng.slice(0,25);
    cs_latlng_2 = cs_latlng.slice(25,cs_latlng.length);

    geocoder = new google.maps.Geocoder();
}
var dmrOptions = null;
var dmr = null;
var responses = null;
var status = null;
var status2 = null;

var order = [];
var tmp = null;
var tableString = null;

var mapclick = false;

var geocoder = null;

function process(e){
    var home = [$('#address').val()];
    geocoder.geocode( { address: home[0]}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var image = {
          url: 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png',
          // This marker is 20 pixels wide by 32 pixels tall.
          scaledSize: new google.maps.Size(24, 24),
        };
        if (home_marker !== null) {
          home_marker.setMap(null);
        }
        home_marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            icon: image
        });
      } else {
        console.log('Geocode was not successful for the following reason: ' + status);
        return;
      }
    });
    dmrOptions = {
      destinations: cs_latlng_1,
      origins: home,
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.IMPERIAL
    };
    dms.getDistanceMatrix(dmrOptions, function(DistanceMatrixResponse, DistanceMatrixStatus){ 
      responses = DistanceMatrixResponse.rows[0].elements;
      status = DistanceMatrixStatus;
      dmrOptions = {
        destinations: cs_latlng_2,
        origins: home,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      };
      dms.getDistanceMatrix(dmrOptions, function(DistanceMatrixResponse, DistanceMatrixStatus){
        responses = responses.concat(DistanceMatrixResponse.rows[0].elements);
        status2 = DistanceMatrixStatus;
        order = [];
        for (j = 0; j < cs_latlng.length; j++){
          tmp = {
            city: listOfSites.cities[j].cname,
            distance_text: responses[j].distance.text,
            distance: responses[j].distance.value,
            duration_text: responses[j].duration.text,
            duration: responses[j].duration.value
          };
          if ($('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
            // Do nothing
          } else if ( $('#excludeMonday').prop('checked') && listOfSites.cities[j].tuesday == "0") {
            // Do nothing
          } else if ( $('#excludeTuesday').prop('checked') && listOfSites.cities[j].monday == "0") {
            // Do nothing
          } else {
            order.push(tmp);
          }
        }
        order = qsort(order);
        tableString = '';
        // Create Table String
        tableString = '<table id="myTable" class="table table-striped"><thead><tr><th>Site</th><th>Duration</th><th>Distance</th></tr></thead><tbody>';
        for(k = 0; k < order.length; k++){
          tableString = tableString + '<tr class="myRow" cityname=' + order[k].city + '><td>' + order[k].city + '</td><td>' + order[k].duration_text + '</td><td>' + order[k].distance_text + '</td></tr>';
        }
        tableString = tableString + '</tbody></table>';
        // Insert new element
        $('#myTable').remove()
        $('#table-area').append(tableString);
      });
    });
}

$(document).ready(function(){
  $('#find').on('click', function (e) {
    e.preventDefault();
    process(e);
  });
  $('form input').keydown(function(e){
    if(e.keyCode == 13) {
      e.preventDefault();
      process(e);
    }
  });
  $('#excludeMonday').change(function(){
    if ($('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(false);
      }
    } else if ($('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        if (listOfSites.cities[i].tuesday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else if (!$('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
        if (listOfSites.cities[i].monday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else {
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
      }
    }
  });
  $('#excludeTuesday').change(function(){
    if ($('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(false);
      }
    } else if ($('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        if (listOfSites.cities[i].monday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else if (!$('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
        if (listOfSites.cities[i].tuesday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else {
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
      }
    }
  });
  $(document).on("mouseenter", ".myRow", function() {
    mapclick = false;
    var cname = "";
    for(i = 0; i < listOfSites.cities.length; i++){
      if (listOfSites.cities[i].cname.split(" ").length > 1){
        cname = listOfSites.cities[i].cname.substr(0, listOfSites.cities[i].cname.indexOf(" "));
      } else {
        cname = listOfSites.cities[i].cname
      }
      if (cname != $(this).attr('cityname')){
        cs_marker[i].setVisible(false);
      }
    }
  });
  $(document).on("mouseleave", ".myRow", function() {
    if(!mapclick){
      for(i = 0; i < listOfSites.cities.length; i++){
        if ($('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
          for (i = 0; i < cs_marker.length; i++){
            cs_marker[i].setVisible(false);
          }
        } else if (!$('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')) {
          if (listOfSites.cities[i].monday != "0"){
            cs_marker[i].setVisible(true);
          }
        } else if (!$('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')) {
          if (listOfSites.cities[i].tuesday != "0"){
            cs_marker[i].setVisible(true);
          }
        } else {
          cs_marker[i].setVisible(true);
        }
      }
    }
  });
  $(document).on("click", ".myRow", function() {
    mapclick = true;
    for(i = 0; i < listOfSites.cities.length; i++){
      if (listOfSites.cities[i].cname.split(" ").length > 1){
        cname = listOfSites.cities[i].cname.substr(0, listOfSites.cities[i].cname.indexOf(" "));
      } else {
        cname = listOfSites.cities[i].cname
      }
      if (cname != $(this).attr('cityname')){
        cs_marker[i].setVisible(false);
      }
    }
  });
});

google.maps.event.addDomListener(window, 'load', initialize);